# backend/api/serializers.py
# –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä—ã –ø—Ä–µ–æ–±—Ä–∞–∑—É—é—Ç –æ–±—ä–µ–∫—Ç—ã Django (–º–æ–¥–µ–ª–∏) –≤ JSON –∏ –æ–±—Ä–∞—Ç–Ω–æ.
# –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ REST API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É –∏ –ø—Ä–∏—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –Ω–µ–≥–æ.

from rest_framework import serializers
from polls.models import Poll, Question, Choice, Vote

# –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞ (Choice) —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π.
# –í–∫–ª—é—á–∞–µ—Ç: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤, –ø—Ä–æ—Ü–µ–Ω—Ç –∏ –ø—Ä–∏–∑–Ω–∞–∫ "–≥–æ–ª–æ—Å–æ–≤–∞–ª –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å".
class ChoiceWithStatsSerializer(serializers.ModelSerializer):
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è, –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥—ã (SerializerMethodField)
    vote_count = serializers.SerializerMethodField()   # –û–±—â–µ–µ —á–∏—Å–ª–æ –≥–æ–ª–æ—Å–æ–≤ –∑–∞ —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç
    percentage = serializers.SerializerMethodField()   # –ü—Ä–æ—Ü–µ–Ω—Ç –≥–æ–ª–æ—Å–æ–≤ –ø–æ –≤–æ–ø—Ä–æ—Å—É
    my_votes = serializers.SerializerMethodField()     # –°–ø–∏—Å–æ–∫ ID –≥–æ–ª–æ—Å–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    class Meta:
        model = Choice
        # –ü–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –≤–∫–ª—é—á–µ–Ω—ã –≤ JSON-–æ—Ç–≤–µ—Ç
        fields = ['id', 'text', 'vote_count', 'percentage', 'my_votes']

    # –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞ –≥–æ–ª–æ—Å–æ–≤ –∑–∞ —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞.
    # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å —á–µ—Ä–µ–∑ ForeignKey: —É Choice –µ—Å—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö Vote.
    def get_vote_count(self, obj):
        return obj.vote_set.count()

    # –ú–µ—Ç–æ–¥ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –≥–æ–ª–æ—Å–æ–≤ –∑–∞ —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞ –≥–æ–ª–æ—Å–æ–≤ –ø–æ –≤–æ–ø—Ä–æ—Å—É.
    # –í–∞–∂–Ω–æ: –≥–æ–ª–æ—Å–∞ —Å—á–∏—Ç–∞—é—Ç—Å—è –ù–ï –ø–æ Question (—É –Ω–µ–≥–æ –Ω–µ—Ç vote_set), –∞ –ø–æ –≤—Å–µ–º Choice, –æ—Ç–Ω–æ—Å—è—â–∏–º—Å—è –∫ –æ–¥–Ω–æ–º—É Question.
    def get_percentage(self, obj):
        # üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: —Å—á–∏—Ç–∞–µ–º –≥–æ–ª–æ—Å–∞ –ø–æ Question —á–µ—Ä–µ–∑ Choice
        # –§–∏–ª—å—Ç—Ä—É–µ–º –≤—Å–µ –≥–æ–ª–æ—Å–∞ (Vote), –≥–¥–µ choice –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–æ–º—É –∂–µ –≤–æ–ø—Ä–æ—Å—É (question), —á—Ç–æ –∏ —Ç–µ–∫—É—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç (obj)
        total_votes = Vote.objects.filter(choice__question=obj.question).count()
        if total_votes == 0:
            return 0.0
        votes_for_this = obj.vote_set.count()
        return round(votes_for_this / total_votes * 100, 1)

    # –ú–µ—Ç–æ–¥ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –≥–æ–ª–æ—Å–æ–≤–∞–ª –ª–∏ –¢–ï–ö–£–©–ò–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –∑–∞ —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç.
    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ID –µ–≥–æ –≥–æ–ª–æ—Å–æ–≤ (–æ–±—ã—á–Ω–æ 0 –∏–ª–∏ 1, —Ç–∞–∫ –∫–∞–∫ –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –º–æ–∂–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑).
    # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è "–í–∞—à –≤—ã–±–æ—Ä" –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è.
    def get_my_votes(self, obj):
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–ø–µ—Ä–µ–¥–∞—á–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –≤ PollList)
        request = self.context.get('request')
        # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ—Ç –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
        if not request or not request.user.is_authenticated:
            return []
        # –ò—â–µ–º –≥–æ–ª–æ—Å–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (request.user) –ø–æ —ç—Ç–æ–º—É –≤–∞—Ä–∏–∞–Ω—Ç—É (obj)
        return list(obj.vote_set.filter(user=request.user).values_list('id', flat=True))


# –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ (Question).
# –í–∫–ª—é—á–∞–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ —Å –ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π —á–µ—Ä–µ–∑ ChoiceWithStatsSerializer.
class QuestionSerializer(serializers.ModelSerializer):
    # –ü–æ–ª–µ choices ‚Äî —ç—Ç–æ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã Choice.
    # many=True ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –∏–º–µ–µ—Ç –º–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.
    # read_only=True ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–∞ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è (–æ–Ω–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç).
    choices = ChoiceWithStatsSerializer(many=True, read_only=True)

    class Meta:
        model = Question
        fields = ['id', 'text', 'choices']


# –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è –æ–ø—Ä–æ—Å–∞ (Poll).
# –í–∫–ª—é—á–∞–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π.
class PollSerializer(serializers.ModelSerializer):
    # –ü–æ–ª–µ questions ‚Äî —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã Question.
    # many=True ‚Äî –æ–¥–∏–Ω –æ–ø—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç –º–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤.
    # read_only=True ‚Äî –≤–æ–ø—Ä–æ—Å—ã –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–ø—Ä–æ—Å–∞.
    questions = QuestionSerializer(many=True, read_only=True)

    class Meta:
        model = Poll
        fields = ['id', 'title', 'date_created', 'questions']


# –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥–æ–ª–æ—Å–∞ (Vote).
# –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ ID –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞ (choice).
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ POST-–∑–∞–ø—Ä–æ—Å–µ –Ω–∞ /api/vote/.
class VoteSerializer(serializers.ModelSerializer):
    class Meta:
        model = Vote
        fields = ['choice']